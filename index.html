<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inflow and Outflow by Country</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      text-align: center;
    }
    #chart-container {
      width: 90%;
      max-width: 1400px;
      margin: 0 auto;
    }
    .filters {
      margin-bottom: 20px;
    }
    select {
      margin: 0 10px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h2>Inflow and Outflow by Country</h2>

  <div class="filters">
    <label for="country">Country:</label>
    <select id="country">
      <option value="TOTAL">TOTAL</option>
      <option value="IRAN">IRAN</option>
      <option value="PAK">PAK</option>
    </select>

    <label for="flow">Flow Type:</label>
    <select id="flow">
      <option value="BOTH">Inflow & Outflow</option>
      <option value="INFLOW">Inflow Only</option>
      <option value="OUTFLOW">Outflow Only</option>
    </select>
  </div>

  <div id="chart-container">
    <canvas id="lineChart"></canvas>
  </div>

  <script>
    let chart;

    function normalizeValue(val) {
      return typeof val === "number" ? val : Number(val.toString().replace(/,/g, '').trim()) || 0;
    }

    function updateChart(data, country, flowType) {
      const dates = [];
      const inflows = [];
      const outflows = [];

      data.forEach(row => {
        const date = row["date"]?.trim();
        if (!date) return;
        dates.push(date);

        if (country === "TOTAL") {
          inflows.push(normalizeValue(row["TOTAL - INFLOW"]));
          outflows.push(normalizeValue(row["TOTAL - OUTFLOW"]));
        } else {
          inflows.push(normalizeValue(row[`INFLOW - ${country}`]));
          outflows.push(normalizeValue(row[`OUTFLOW - ${country}`]));
        }
      });

      const datasets = [];
      if (flowType === "INFLOW" || flowType === "BOTH") {
        datasets.push({
          label: "Inflow",
          data: inflows,
          borderColor: "rgba(92, 184, 178, 1)",
          backgroundColor: "rgba(231, 244, 243, 0.2)",
          fill: false,
          tension: 0.1
        });
      }
      if (flowType === "OUTFLOW" || flowType === "BOTH") {
        datasets.push({
          label: "Outflow",
          data: outflows,
          borderColor: "rgba(0, 51, 160, 1)",
          backgroundColor: "rgba(217, 224, 241, 0.2)",
          fill: false,
          tension: 0.1
        });
      }

      if (chart) chart.destroy();

      const ctx = document.getElementById('lineChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: `Flow Data: ${country}`
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Date' }
            },
            y: {
              title: { display: true, text: 'Individuals' },
              beginAtZero: true
            }
          }
        }
      });
    }

    Papa.parse("https://osamaalkhalifa.github.io/FM_linechart/data.csv", {
      download: true,
      header: true,
      dynamicTyping: false,
      complete: function(results) {
        const rawData = results.data.filter(row => row["date"]);
        const countrySelect = document.getElementById("country");
        const flowSelect = document.getElementById("flow");

        updateChart(rawData, countrySelect.value, flowSelect.value);

        countrySelect.addEventListener("change", () => {
          updateChart(rawData, countrySelect.value, flowSelect.value);
        });
        flowSelect.addEventListener("change", () => {
          updateChart(rawData, countrySelect.value, flowSelect.value);
        });
      },
      error: function(error) {
        console.error("Error parsing CSV:", error);
      }
    });
  </script>
</body>
</html>
